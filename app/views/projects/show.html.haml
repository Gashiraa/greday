#project-id{"data-somedata" => "#{@project.id}"}
#project-customer-id{"data-somedata" => "#{@project.customer.id}"}
#project-no-vat{"data-somedata" => "#{@project.no_vat}"}
#customer-rate{"data-somedata" => "#{@project.customer.customer_rate}"}
%div
  .project-content
    .ui.left.rail
      .ui
        .ui.cards
          .card
            .content
              .header
                = @project.name
                = link_to edit_project_path(@project), remote: true do
                  %button.edit-card-button.ui.compact.icon.blue.button
                    %i.edit.icon
              .meta
                - if @project.customer
                  = @project.customer.name
                  = link_to edit_customer_path(@project.customer), remote: true do
                    = image_tag("edit-icon.png", size: "20x20")
                %br/
                = l(@project.date)
              .description
                = @project.description
                %br/
              .description
                - if @project.no_vat
                  %b Pas de TVA
                %br/
            .content.center.aligned
              %p.center.aligned
                = t('status')
              .color-table
                = tag.div class: 'center aligned status-cell', status: @project.status do
                  %div
                    = @project.translated_status
            .content
              .center.aligned
                %h3
                  = t('project_total_gross') + ' : ' + (number_with_precision @project.total_gross, :precision => 2).to_s + ' €'
                %h4
                  = t('project_total') + ' : ' + (number_with_precision @project.total, :precision => 2).to_s + ' €'
            = link_to "Dupliquer le projet", {id: @project.id, action: :duplicate, controller: :projects, :method => :get}, {class: "ui bottom attached olive button card-button"}
            = link_to project_path(@project, :format => :pdf), :method => :get, form: {target: "_blank"}, class: "ui bottom attached teal button" do
              %i.file.pdf.icon
              Voir le devis
              %br/
            - case @project.status
              - when "quotation"
                = link_to t('switch_in_progress'), project_path(@project, project: {status: :in_progress}), method: :put, class: 'ui bottom attached orange button'
              - when "in_progress"
                = link_to t('do_done'), project_path(@project, project: {status: :done}), method: :put, class: 'ui bottom attached red button'
              - when "created"
                = link_to t('do_accepted'), project_path(@project, project: {status: :accepted}), method: :put, class: 'ui bottom attached red button card-button'
              - when "done"
                = link_to t('invoice_project').capitalize, new_invoice_path(project: @project.id), :method => :get, :remote => true, class: 'ui bottom attached yellow button'
              - when "accepted"
                = link_to t('invoice_project').capitalize, new_invoice_path(project: @project.id), :method => :get, :remote => true, class: 'ui bottom attached yellow button'
              - when "invoiced"
                - if @project.invoice
                  = link_to invoice_path(@project.invoice, :format => :pdf), :method => :get, form: {target: "_blank"}, class: "ui bottom attached yellow button", :target => "_blank" do
                    %i.file.pdf.icon
                    Voir la facture
                = link_to project_path(@project, project: {status: :paid}), method: :put, class: 'ui bottom attached green button' do
                  %i.euro.sign.icon
                  =t('project_paid')
            = link_to(:projects, class: "ui top attached grey button") do
              %i.left.arrow.icon
              =t('back')
          - if @project.machine_id
            .card
              .content
                .header
                  = link_to machine_path(@machine) do
                    = @machine.brand + " " + @machine.model
                  = link_to edit_machine_path(@machine), remote: true do
                    %button.edit-card-button.ui.compact.icon.purple.button
                      %i.edit.icon
                .meta
                  = @machine.category
                  %br/
                .description
                  = @machine.customer ? @machine.customer.name : ""
                  %br/
                  = "Année : " + (@machine.year ? @machine.year : "")
                  %br/
                  = "Numéro de série : " + (@machine.serial ? @machine.serial : "")
                  %br/
              .content
                .description
                  = @machine.comment
                  %br/
              .content
                .header
                  = t("history_machine")
                  = link_to new_machine_history_path(:machine => @machine.id), remote: true do
                    %button.edit-card-button.ui.compact.icon.purple.button
                      %i.plus.icon
                .meta
                  = @machine.isKm ? t('km_usage') : t('hours')
                  %br/
                .description
                  %table.ui.striped.selectable.table.table-to-color
                    %tbody
                      - @machine_history.each do |history|
                        %tr
                          %td
                            = l(history.date)
                          %td
                            = history.amount
                          %td
                            = link_to edit_machine_history_path(history, :machine => @machine.id), remote: true do
                              = image_tag("edit-icon.png", size: "15x15")
                            = link_to history, method: :delete, data: {confirm: t('confirm_delete')} do
                              = image_tag("delete-icon.png", size: "15x15")
    -#----[SERVICES]----
    - if @company.use_services
      .ui.segment{style: "margin-top:0"}
        .project-section
          %h3
            = t('service').pluralize.capitalize
            = link_to(new_service_path, {:remote => true, 'data-toggle' => "modal", 'data-target' => '#modal-window'}) do
              %button.ui.red.compact.labeled.icon.button
                Ajouter une prestation
                %i.plus.icon
          .scrollable-project-section
            %table.ui.striped.selectable.red.compact.table.table-to-color
              %thead.thead-dark
                %tr
                  %th.four.wide
                    = t('Name')
                  %th.two.wide.center.aligned
                    = t('status')
                  %th.one.wide.center.aligned
                    = t('Date')
                  %th.two.wide.right.aligned
                    = t('hourly_rate').to_s
                  %th.one.wide.right.aligned
                    = t('duration').to_s
                  %th.two.wide.right.aligned
                    = t('total_gross')
                    (€)
                  %th.two.wide.right.aligned
                    = t('total_cost')
                    (€)
                  %th.two.wide
              - unless @project.services.any?
                %tr
                  %td.center.aligned{colspan: "9"} Aucune données à afficher
              - @project.services.order(date: :asc).each do |service|
                %tr{"data-link" => "#{edit_service_path(service)}"}
                  %td= service.name
                  = tag.td class: 'center aligned status-cell', status: service.status do
                    %div
                      %div
                        = service.translated_status
                  %td.center.aligned
                    = service.date ? l(service.date) : ""
                  %td.right.aligned
                    = number_with_precision service.hourly_rate, :precision => 2
                  %td.right.aligned
                    = service.duration.strftime('%H:%M')
                  %td.right.aligned
                    = number_with_precision service.total_gross, :precision => 2
                  %td.right.aligned
                    = number_with_precision service.total_cost, :precision => 2
                  %td.right.aligned
                    = link_to edit_service_path(service), remote: true do
                      = image_tag("edit-icon.png", size: "30x30")
                    = link_to service, method: :delete, data: {confirm: t('confirm_delete')} do
                      = image_tag("delete-icon.png", size: "30x30")
          %table.ui.compact.table.total-section
            %tr
              %td
              %td.right.aligned
                = t('total_duration') + ' : '
                %b
                  = +Service.where(project_id: @project.id).sum(:duration).to_s.chop.chop.chop
              %td.two.wide.right.aligned
                = t('total_gross') + ' : '
                %b
                  = (number_with_precision @project.services.collect { |s| s.valid? ? s.total_gross : 0 }.sum, :precision => 2).to_s + "€"
              %td.two.wide.right.aligned
                = t('total') + ' : '
                %b
                  = (number_with_precision @project.services.collect { |s| s.valid? ? s.total_cost : 0 }.sum, :precision => 2).to_s + "€"
              %td.two.wide
    -#----[WARES]----
    - if @company.use_wares
      .ui.segment
        .project-section
          %h3
            = t('ware').pluralize.capitalize
            = link_to(new_ware_path, {:remote => true, 'data-toggle' => "modal", 'data-target' => '#modal-window'}) do
              %button.ui.violet.compact.labeled.icon.button
                Ajouter une marchandise
                %i.plus.icon
          .scrollable-project-section
            %table.ui.compact.selectable.violet.compact.table.table-to-color
              %thead
                %tr
                  %th.four.wide
                    = t('ware_name')
                  %th.two.wide.center.aligned= t('status')
                  %th.six.wide.right.aligned
                    = t('total_gross')
                    (€)
                  %th.two.wide.right.aligned
                    = t('total_cost')
                    (€)
                  %th.two.wide
              %tbody
                - unless @project.wares.any?
                  %tr
                    %td.center.aligned{colspan: "9"} Aucune données à afficher
                - @project.wares.where("total_gross = 0").each do |ware|
                  %tr.red-row{"data-link" => "#{edit_ware_path(ware)}"}
                    %td
                      = ware.ware_name
                      = tag.td class: 'center aligned status-cell', status: ware.status do
                        %div
                          %div
                            = ware.translated_status
                      %td.right.aligned
                        = number_with_precision ware.total_gross, :precision => 2
                      %td.right.aligned
                        = number_with_precision ware.total_cost, :precision => 2
                      %td.right.aligned
                        = link_to edit_ware_path(ware), remote: true do
                          = image_tag("edit-icon.png", size: "30x30")
                        = link_to ware, method: :delete, data: {confirm: t('confirm_delete')} do
                          = image_tag("delete-icon.png", size: "30x30")
                - @project.wares.where("total_gross > 0").each do |ware|
                  %tr{"data-link" => "#{edit_ware_path(ware)}"}
                    %td
                      = ware.ware_name
                    = tag.td class: 'center aligned status-cell', status: ware.status do
                      %div
                        %div
                          = ware.translated_status
                    %td.right.aligned
                      = number_with_precision ware.total_gross, :precision => 2
                    %td.right.aligned
                      = number_with_precision ware.total_cost, :precision => 2
                    %td.right.aligned
                      = link_to edit_ware_path(ware), remote: true do
                        = image_tag("edit-icon.png", size: "30x30")
                      = link_to ware, method: :delete, data: {confirm: t('confirm_delete')} do
                        = image_tag("delete-icon.png", size: "30x30")
            %table.ui.compact.table.total-section
              %tr
                %td.twelve.wide.right.aligned
                  = t('total_gross') + ' : '
                  %b
                    = (number_with_precision @project.wares.collect { |s| s.valid? ? s.total_gross : 0 }.sum, :precision => 2).to_s + "€"
                %td.two.wide.right.aligned
                  = t('total') + ' : '
                  %b
                    = (number_with_precision @project.wares.collect { |s| s.valid? ? s.total_cost : 0 }.sum, :precision => 2).to_s + "€"
                %td.two.wide
    -#----[EXTRAS]----
    .ui.segment
      .project-section
        %h3
          = @company.use_articles == false ? t('extra') : t('article')
          = link_to(new_project_extra_line_path, {:remote => true, 'data-toggle' => "modal", 'data-target' => '#modal-window'}) do
            %button.ui.yellow.compact.labeled.icon.button
              = @company.use_articles == false ? t('add_extra') : t('add_article')
              %i.plus.icon
          - if @company.use_manual_extras
            = link_to("project_extra_lines/new_manual", :remote => true, 'data-toggle' => "modal", 'data-target' => '#modal-window') do
              %button.ui.teal.compact.labeled.icon.button
                Ajouter un article (manuel)
                %i.plus.icon
        .scrollable-project-section
          %table.ui.striped.selectable.yellow.compact.table.table-to-color
            %thead
              %tr
                %th.four.wide= t('Name')
                %th.three.wide.center.aligned= t('unit')
                %th.two.wide.right.aligned= t('quantity')
                %th.three.wide.right.aligned
                  = t('total_gross')
                  (€)
                %th.two.wide.right.aligned
                  = t('total_cost')
                  (€)
                %th.two.wide
            %tbody
              - unless @project.project_extra_lines.any?
                %tr
                  %td.center.aligned{colspan: "9"}= t('no_data_display')
              - @project.project_extra_lines.order(:updated_at).each do |project_extra_line|
                - if project_extra_line.is_manual
                  %tr
                    %td
                      = project_extra_line.manual_name
                    %td.center.aligned
                      = project_extra_line.unit
                    %td.right.aligned
                      = project_extra_line.quantity
                    %td.right.aligned
                      = number_with_precision project_extra_line.total_gross, :precision => 2
                    %td.right.aligned
                      = number_with_precision project_extra_line.total, :precision => 2
                    %td.center.aligned
                      = link_to "project_extra_lines/edit_manual/" + project_extra_line.id.to_s, remote: true do
                        = image_tag("edit-icon.png", size: "30x30")
                      = link_to project_extra_line, method: :delete, data: {confirm: t('confirm_delete')} do
                        = image_tag("delete-icon.png", size: "30x30")
                - else
                  %tr{"data-link" => "#{edit_project_extra_line_path(project_extra_line)}"}
                    %td
                      = project_extra_line.extra.name
                    %td.center.aligned
                      = project_extra_line.extra.unit
                    %td.right.aligned
                      = project_extra_line.quantity
                    %td.right.aligned
                      = number_with_precision project_extra_line.total_gross, :precision => 2
                    %td.right.aligned
                      = number_with_precision project_extra_line.total, :precision => 2
                    %td.center.aligned
                      = link_to edit_project_extra_line_path(project_extra_line), remote: true do
                        = image_tag("edit-icon.png", size: "30x30")
                      = link_to project_extra_line, method: :delete, data: {confirm: t('confirm_delete')} do
                        = image_tag("delete-icon.png", size: "30x30")
          %table.ui.compact.table.total-section
            %tr
              %td.twelve.wide.right.aligned
                = t('total_gross') + ' : '
                %b
                  = (number_with_precision @project.project_extra_lines.collect { |s| s.total_gross }.sum, :precision => 2).to_s + "€"
              %td.two.wide.right.aligned
                = t('total') + ' : '
                %b
                  = (number_with_precision @project.project_extra_lines.collect { |s| s.total }.sum, :precision => 2).to_s + "€"
              %td.two.wide.right.aligned
#modal-window.ui.modal
  .content